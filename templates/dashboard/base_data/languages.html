{% extends 'dashboard/base.html' %}
{% load page_tags %}

{% block stage %}
<style>
    .language-manager {
        background: #f8fafc;
        min-height: 100%;
        padding: 56px 0 44px;
    }

    .language-container {
        max-width: 1100px;
        margin: 0 auto;
        padding: 0 24px;
        display: flex;
        flex-direction: column;
        gap: 24px;
    }

    .language-header {
        display: flex;
        flex-wrap: wrap;
        justify-content: space-between;
        gap: 24px;
    }

    .language-header__content h1 {
        font-size: 1.8rem;
        font-weight: 700;
        color: #0f172a;
        margin-bottom: 6px;
    }

    .language-header__content p {
        margin: 0;
        color: #5b6b7f;
        max-width: 520px;
        line-height: 1.45;
    }

    .language-header__stats {
        display: grid;
        grid-auto-flow: column;
        grid-auto-columns: minmax(160px, 1fr);
        gap: 16px;
    }

    .language-stat-card {
        background: #ffffff;
        border-radius: 14px;
        border: 1px solid #e2e8f0;
        padding: 16px 18px;
        display: flex;
        flex-direction: column;
        gap: 6px;
        box-shadow: 0 8px 20px rgba(15, 23, 42, 0.08);
    }

    .language-stat-card__label {
        font-size: .75rem;
        letter-spacing: .08em;
        text-transform: uppercase;
        color: #64748b;
    }

    .language-stat-card__value {
        font-size: 1.6rem;
        font-weight: 700;
        color: #1e293b;
    }

    .language-tools {
        display: grid;
        gap: 18px;
        background: #ffffff;
        border-radius: 16px;
        border: 1px solid #e2e8f0;
        box-shadow: 0 10px 28px rgba(15, 23, 42, 0.08);
        padding: 20px;
    }

    .language-form label,
    .language-search label {
        display: block;
        font-size: .78rem;
        text-transform: uppercase;
        letter-spacing: .08em;
        color: #64748b;
        margin-bottom: 8px;
    }

    .language-form__fields,
    .language-search__fields {
        display: flex;
        gap: 12px;
        flex-wrap: wrap;
    }

    .language-form__fields input,
    .language-search__fields input {
        flex: 1;
        min-width: 220px;
        border-radius: 10px;
        border: 1px solid #d1d9e6;
        padding: 10px 14px;
        font-size: .95rem;
        color: #0f172a;
        background: #ffffff;
    }

    .language-form__fields button,
    .language-search__fields button {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        border: none;
        border-radius: 10px;
        padding: 10px 18px;
        font-size: .9rem;
        font-weight: 600;
        cursor: pointer;
        transition: all .18s ease;
        box-shadow: 0 6px 18px rgba(29, 78, 216, 0.18);
    }

    .language-form__fields button {
        background: #1d4ed8;
        color: #ffffff;
    }

    .language-form__fields button:hover {
        background: #1e40af;
        transform: translateY(-1px);
    }

    .language-search__fields button {
        background: #0ea5e9;
        color: #ffffff;
        box-shadow: 0 6px 18px rgba(14, 165, 233, 0.22);
    }

    .language-search__fields button:hover {
        background: #0284c7;
        transform: translateY(-1px);
    }

    .language-results-summary {
        display: flex;
        align-items: center;
        gap: 12px;
        font-size: .9rem;
        color: #4b5563;
    }

    .language-results-summary strong {
        color: #1f2937;
    }

    .language-clear-search {
        font-weight: 600;
        color: #1d4ed8;
    }

    .language-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
        gap: 18px;
    }

    .language-card {
        background: #ffffff;
        border-radius: 16px;
        border: 1px solid #e2e8f0;
        padding: 18px;
        display: flex;
        flex-direction: column;
        gap: 16px;
        box-shadow: 0 12px 28px rgba(15, 23, 42, 0.08);
    }

    .language-card__header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        gap: 16px;
    }

    .language-card__identity {
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .language-card__avatar {
        width: 42px;
        height: 42px;
        border-radius: 50%;
        background: #eef2ff;
        color: #1d4ed8;
        font-weight: 700;
        font-size: 1rem;
        display: flex;
        align-items: center;
        justify-content: center;
        text-transform: uppercase;
    }

    .language-card__title {
        font-size: 1.05rem;
        font-weight: 600;
        color: #0f172a;
        margin: 0;
    }

    .language-card__actions {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
    }

    .language-card__action {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 8px 12px;
        font-size: .82rem;
        font-weight: 600;
        border-radius: 10px;
        border: 1px solid #dbe2f3;
        background: #ffffff;
        color: #1d4ed8;
        transition: all .18s ease;
        cursor: pointer;
    }

    .language-card__action:hover {
        border-color: #94a3b8;
        transform: translateY(-1px);
        box-shadow: 0 6px 16px rgba(29, 78, 216, 0.12);
    }

    .language-card__action.danger {
        color: #b91c1c;
        border-color: #fecaca;
        background: #fee2e2;
    }

    .language-card__action.danger:hover {
        border-color: #fca5a5;
        box-shadow: 0 6px 16px rgba(239, 68, 68, 0.18);
    }

    .language-card__edit {
        display: none;
        border-top: 1px dashed #dbe2f3;
        padding-top: 16px;
    }

    .language-card__edit label {
        font-size: .76rem;
        letter-spacing: .06em;
        text-transform: uppercase;
        color: #64748b;
        margin-bottom: 8px;
    }

    .language-card__edit input {
        width: 100%;
        border-radius: 10px;
        border: 1px solid #dbe2f3;
        padding: 10px 12px;
        font-size: .92rem;
        color: #0f172a;
        background: #ffffff;
    }

    .language-card__edit-actions {
        margin-top: 14px;
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
    }

    .language-card__save,
    .language-card__cancel {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        border-radius: 10px;
        padding: 10px 18px;
        font-size: .85rem;
        font-weight: 600;
        border: none;
        cursor: pointer;
        transition: all .18s ease;
    }

    .language-card__save {
        background: #1d4ed8;
        color: #ffffff;
        box-shadow: 0 6px 16px rgba(29, 78, 216, 0.2);
    }

    .language-card__save:hover {
        background: #1e3a8a;
        transform: translateY(-1px);
    }

    .language-card__cancel {
        background: #f8fafc;
        color: #475569;
        border: 1px solid #e2e8f0;
    }

    .language-card__cancel:hover {
        background: #e2e8f0;
    }

    .language-empty-state {
        background: #ffffff;
        border: 1px dashed #d1d9e6;
        border-radius: 16px;
        padding: 48px 24px;
        text-align: center;
        color: #64748b;
        font-size: 1rem;
        display: flex;
        flex-direction: column;
        gap: 12px;
        box-shadow: inset 0 0 0 1px rgba(219, 226, 243, 0.4);
    }

    .language-empty-state i {
        font-size: 2rem;
        color: #1d4ed8;
    }

    .language-pagination {
        display: flex;
        justify-content: center;
        margin-top: 12px;
    }

    .language-pagination__track {
        max-width: 720px;
        width: 100%;
        display: flex;
        justify-content: space-between;
        gap: 18px;
        padding: 12px 18px;
        background: #ffffff;
        border-radius: 16px;
        border: 1px solid #e2e8f0;
        box-shadow: 0 10px 24px rgba(15, 23, 42, 0.08);
    }

    .language-pagination__group {
        display: flex;
        align-items: center;
        gap: 12px;
        font-size: .88rem;
        color: #4b5563;
        font-weight: 600;
    }

    .language-pagination__group strong {
        color: #1f2937;
    }

    .language-pagination__button {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 8px 16px;
        border-radius: 10px;
        border: 1px solid #d1d5db;
        color: #1f2937;
        background: #ffffff;
        font-weight: 600;
        transition: all .16s ease;
    }

    .language-pagination__button:hover {
        border-color: #9ca3af;
        color: #111827;
        box-shadow: 0 8px 18px rgba(17, 24, 39, 0.12);
    }

    .language-pagination__button--primary {
        color: #1d4ed8;
        border-color: #bfdbfe;
    }

    .language-pagination__button--primary:hover {
        background: #eff6ff;
        border-color: #93c5fd;
        color: #1e3a8a;
    }

    .language-pagination__button--disabled {
        border-color: #e5e7eb;
        color: #9ca3af;
        pointer-events: none;
        background: #f9fafb;
        box-shadow: none;
    }

    .sr-only {
        position: absolute;
        width: 1px;
        height: 1px;
        padding: 0;
        margin: -1px;
        overflow: hidden;
        clip: rect(0, 0, 0, 0);
        border: 0;
    }

    @media (max-width: 992px) {
        .language-header__stats {
            grid-auto-flow: row;
        }
    }

    @media (max-width: 768px) {
        .language-header {
            flex-direction: column;
        }

        .language-pagination__track {
            flex-direction: column;
            align-items: stretch;
        }

        .language-pagination__group {
            justify-content: center;
        }
    }

    @media (max-width: 540px) {
        .language-form__fields,
        .language-search__fields {
            flex-direction: column;
        }

        .language-form__fields button,
        .language-search__fields button {
            width: 100%;
            justify-content: center;
        }

        .language-header__stats {
            grid-auto-columns: 1fr;
        }
    }
</style>
<section class="language-manager">
    <div class="language-container">
        <header class="language-header">
            <div class="language-header__content">
                <h1>Languages</h1>
                <p>Manage the list of languages that appear across the platform. Add new entries, update existing ones, or remove unused languages.</p>
            </div>

            <div class="language-header__stats">
                <article class="language-stat-card">
                    <span class="language-stat-card__label">Total languages</span>
                    <span class="language-stat-card__value">{{ total_languages }}</span>
                </article>
                <article class="language-stat-card">
                    <span class="language-stat-card__label">Shown in results</span>
                    <span class="language-stat-card__value">{{ filtered_count }}</span>
                </article>
            </div>
        </header>

        <div class="language-tools">
            <form id="language-create-form" class="language-form" method="post">
                {% csrf_token %}
                <input type="hidden" name="mode" value="add_language">
                <label for="language_name">Add a new language</label>
                <div class="language-form__fields">
                    <input id="language_name" name="name" type="text" placeholder="e.g. German" autocomplete="off" required>
                    <button type="submit">
                        <i class="fa fa-plus"></i>
                        Add language
                    </button>
                </div>
            </form>

            <form id="language-search-form" class="language-search" method="get">
                <label for="language_search" class="sr-only">Search languages</label>
                <div class="language-search__fields">
                    <input id="language_search" name="search" type="text" placeholder="Search languages..." value="{{ search_value|default_if_none:'' }}">
                    <button type="submit">
                        <i class="fa fa-search"></i>
                        Search
                    </button>
                </div>
                {% if request.GET.page %}
                    <input type="hidden" name="page" value="{{ request.GET.page }}">
                {% endif %}
            </form>
        </div>

        <div class="language-results-summary">
            {% if search_value %}
                <span>Showing <strong>{{ filtered_count }}</strong> result{% if filtered_count|default:0 != 1 %}s{% endif %} for “{{ search_value }}”.</span>
                <a href="{% url 'dashboard:languages' %}" class="language-clear-search">Reset search</a>
            {% else %}
                <span>Showing <strong>{{ filtered_count }}</strong> language{% if filtered_count|default:0 != 1 %}s{% endif %}.</span>
            {% endif %}
        </div>

        {% if languages %}
            <div class="language-grid">
                {% for language in languages %}
                    <article class="language-card">
                        <div class="language-card__header">
                            <div class="language-card__identity">
                                <span class="language-card__avatar">{{ language.name|first|default:"?" }}</span>
                                <h2 class="language-card__title">{{ language.name }}</h2>
                            </div>
                            <div class="language-card__actions">
                                <button type="button" class="language-card__action language-card__action--edit" data-language-id="{{ language.id }}">
                                    <i class="fa-solid fa-pen-to-square"></i>
                                    Edit
                                </button>
                                <a href="{% url 'dashboard:delete_language' language_id=language.id %}" class="language-card__action danger language-card__action--delete" data-language-name="{{ language.name }}">
                                    <i class="fa-solid fa-trash-can"></i>
                                    Delete
                                </a>
                            </div>
                        </div>

                        <div class="language-card__edit" id="language-edit-{{ language.id }}">
                            <form class="language-update-form" method="post">
                                {% csrf_token %}
                                <input type="hidden" name="id" value="{{ language.id }}">
                                <input type="hidden" name="mode" value="edit_language">
                                <input type="hidden" name="page" value="{{ current_page }}">
                                <label for="language_name_{{ language.id }}">Language name</label>
                                <input id="language_name_{{ language.id }}" name="name" type="text" value="{{ language.name }}" required>
                                <div class="language-card__edit-actions">
                                    <button type="submit" class="language-card__save">
                                        <i class="fa-solid fa-floppy-disk"></i>
                                        Save changes
                                    </button>
                                    <button type="button" class="language-card__cancel" data-language-id="{{ language.id }}">
                                        Cancel
                                    </button>
                                </div>
                            </form>
                        </div>
                    </article>
                {% endfor %}
            </div>
        {% else %}
            <div class="language-empty-state">
                <i class="fa-solid fa-language"></i>
                <p>No languages found. Use the form above to add your first language.</p>
            </div>
        {% endif %}

        {% if languages %}
            {% get_page current_page last_page as pages %}
            <nav class="language-pagination" aria-label="Language pagination">
                <div class="language-pagination__track">
                    <div class="language-pagination__group">
                        {% if current_page > 1 %}
                            <a class="language-pagination__button language-pagination__button--primary" href="?{% if search_value %}search={{ search_value|urlencode }}&{% endif %}page=1">&laquo;</a>
                            <a class="language-pagination__button" href="?{% if search_value %}search={{ search_value|urlencode }}&{% endif %}page={{ previous_page }}">&lsaquo; Previous</a>
                        {% else %}
                            <span class="language-pagination__button language-pagination__button--disabled">&laquo;</span>
                            <span class="language-pagination__button language-pagination__button--disabled">&lsaquo; Previous</span>
                        {% endif %}
                    </div>
                    <div class="language-pagination__group">
                        <span>Page <strong>{{ current_page }}</strong> of {{ last_page }}</span>
                    </div>
                    <div class="language-pagination__group">
                        {% if current_page < last_page %}
                            <a class="language-pagination__button" href="?{% if search_value %}search={{ search_value|urlencode }}&{% endif %}page={{ aft_page }}">Next &rsaquo;</a>
                            <a class="language-pagination__button language-pagination__button--primary" href="?{% if search_value %}search={{ search_value|urlencode }}&{% endif %}page={{ last_page }}">Last &raquo;</a>
                        {% else %}
                            <span class="language-pagination__button language-pagination__button--disabled">Next &rsaquo;</span>
                            <span class="language-pagination__button language-pagination__button--disabled">Last &raquo;</span>
                        {% endif %}
                    </div>
                </div>
            </nav>
        {% endif %}
    </div>
</section>
{% endblock stage %}

{% block script %}
<script type="text/javascript">
    (function ($) {
        function showMessage(response, title, redirectUrl) {
            if (typeof open_dialog_with_url === 'function' && redirectUrl) {
                open_dialog_with_url(response, title, redirectUrl);
            } else if (typeof open_dialog === 'function') {
                open_dialog(response, title);
                if (redirectUrl) {
                    window.location.href = redirectUrl;
                }
            } else {
                alert(response);
                if (redirectUrl) {
                    window.location.href = redirectUrl;
                }
            }
        }

        function getLanguagesRedirect(page) {
            const params = new URLSearchParams(window.location.search);
            if (page) {
                params.set('page', page);
            }
            return `{{ request.path }}` + (params.toString() ? `?${params.toString()}` : '');
        }

        $(document).on('click', '.language-card__action--edit', function () {
            const languageId = $(this).data('language-id');
            const $panel = $(`#language-edit-${languageId}`);
            $('.language-card__edit').not($panel).slideUp(150);
            $panel.stop(true, true).slideToggle(150);
        });

        $(document).on('click', '.language-card__cancel', function () {
            const languageId = $(this).data('language-id');
            const $panel = $(`#language-edit-${languageId}`);
            $panel.slideUp(150);
        });

        $('#language-create-form').on('submit', function (event) {
            event.preventDefault();
            const $form = $(this);

            $.post('.', $form.serialize(), function (data) {
                if (data.error === false) {
                    showMessage(data.message, 'Success', getLanguagesRedirect());
                } else {
                    showMessage(data.message, 'Error');
                }
            }, 'json');
        });

        $(document).on('submit', '.language-update-form', function (event) {
            event.preventDefault();
            const $form = $(this);

            $.post('.', $form.serialize(), function (data) {
                if (data.error === false) {
                    showMessage(
                        data.message,
                        'Success',
                        '{% url "dashboard:languages" %}?page=' + (data.page || '{{ current_page }}')
                    );
                } else {
                    const message = data.message || data.response || 'Unable to update language.';
                    showMessage(message, 'Info');
                }
            }, 'json');
        });

        $(document).on('click', '.language-card__action--delete', function (event) {
            const languageName = $(this).data('language-name');
            if (!confirm(`Delete “${languageName}”? This action cannot be undone.`)) {
                event.preventDefault();
            }
        });
    })(jQuery);
</script>
{% endblock script %}
